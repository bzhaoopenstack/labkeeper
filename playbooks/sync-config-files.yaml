# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
---
- name: Install hub both in nodepool and zuul
  hosts: nodepool:zuul
  become: yes
  tasks:
    - name: Install hub
      shell:
        cmd: |
          ## check hub installed or not
          if hub version >> /dev/null;then
              echo "hub has been installed!"
          else
              echo "hub installing..."
              wget https://github.com/github/hub/releases/download/v2.10.0/hub-linux-amd64-2.10.0.tgz
              sudo tar -C /usr/local/src -xzf hub-linux-amd64-2.10.0.tgz
              cd /usr/local/src/hub-linux-amd64-2.10.0
              sudo ./install
              hub version
              echo "hub installed success!"
          fi
        executable: /bin/bash

- name: Install other tools in nodepool
  hosts: nodepool
  become: yes
  tasks:
    - name: Install shyaml,ansible and ruamel.yaml
      pip:
        name: "{{ item }}"
      with_items:
        - shyaml
        - ruamel.yaml
        - ansible

- name: Copy script to zuul nodes
  become: yes
  hosts: zuul
  tasks:
    - name: Copy zuul_files_sync.sh into place.
      copy:
        dest: /home/ubuntu/zuul_files_sync.sh
        src: "{{ labkeeper_src_dir }}/labsync/zuul_files_sync.sh"


- name: Zuul files sync script
  hosts: zuul
  become: yes
  vars_files:
    - "{{ labkeeper_src_dir }}/labsync/labsync_vars.yaml"
  tasks:
    - name: Call config file sync script
      shell:
        cmd: |
          # add cron to create pr to github at utc 17:00 every day
          touch sync_cron.cron
          echo "* 17 * * * bash /home/ubuntu/zuul_files_sync.sh {{ github_username }} {{ github_useremail }} {{ github_password }} {{ deploy_type }} >> /var/log/sync.log 2>&1" >>  sync_cron.cron
          crontab sync_cron.cron

        executable: /bin/bash

- name: Copy script to nodepool
  become: yes
  hosts: nodepool
  tasks:
    - name: Copy nodepool_files_sync.sh into place.
      copy:
        dest: /home/ubuntu/nodepool_files_sync.sh
        src: "{{ labkeeper_src_dir }}/labsync/nodepool_files_sync.sh"
    - name: Copy modify_files.py into place.
        copy:
          dest: /home/ubuntu/modify_files.py
          src: "{{ labkeeper_src_dir }}/labsync/modify_files.py"

- name: Nodepool files sync script
  hosts: nodepool
  become: yes
  vars_files:
    - "{{ labkeeper_src_dir }}/labsync/labsync_vars.yaml"
  tasks:
    - name: Call config file monitor and sync script
      shell:
        cmd: |
          vault_password=`cat {{ labkeeper_src_dir }}/vault-password.txt`
          # add cron to create pr to github at utc 16:00 every day
          touch sync_cron.cron
          echo "* 16 * * * bash /home/ubuntu/nodepool_files_sync.sh {{ github_username }} {{ github_useremail }} {{ github_password }} {{ deploy_type }} $vault_password >> /var/log/sync.log 2>&1" >>  sync_cron.cron
          crontab sync_cron.cron

        executable: /bin/bash
